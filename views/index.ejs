<!DOCTYPE html>
<html>
<head>
  <title>Live GPS Tracker</title>
</head>
<body>
  <h2>Tracking as <%= userId %></h2>
  <form id="locationForm" action="/update" method="POST">
    <input type="hidden" name="userId" value="<%= userId %>">
    <input type="hidden" id="lat" name="latitude">
    <input type="hidden" id="lon" name="longitude">
    <p>Getting your location...</p>
  </form>

  <div id="map" style="height: 500px; width: 100%;"></div>
  <a href="/logout">Logout</a>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let map, markers = {};

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 22.3072, lng: 73.1812 }
      });

      const users = JSON.stringify(users)
      users.forEach(user => {
        const marker = new google.maps.Marker({
          position: { lat: user.latitude, lng: user.longitude },
          map: map,
          title: user.userId
        });
        markers[user.userId] = marker;
      });
    }

    socket.on('locationUpdate', (data) => {
      const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
      if (markers[data.userId]) {
        markers[data.userId].setPosition(pos);
      } else {
        const marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: data.userId
        });
        markers[data.userId] = marker;
      }
    });

    window.onload = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          document.getElementById('lat').value = position.coords.latitude;
          document.getElementById('lon').value = position.coords.longitude;
          document.getElementById('locationForm').submit();
        });
      }
    };
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8w0YdRJ9DCwhYKO80zLMqMcGcUnO9gkk&callback=initMap"></script>
</body>
</html>